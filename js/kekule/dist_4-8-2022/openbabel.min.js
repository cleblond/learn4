Kekule.LOCAL_RES=!0,Kekule.Localization.setCurrModule("extra.openbabel"),Kekule.Localization.addResource("en","ErrorMsg",{OpenBabel:{CHEM_NODE_TYPE_NOT_SUITABLE:"Unsuitable node type",CHEM_CONNECTOR_TYPE_NOT_SUITABLE:"Unsuitable connector type",ONLY_STR_INPUT_DATA_ALLOWED:"Input data must be text",ONLY_STR_OUTPUT_DATA_ALLOWED:"Output data must be text",FAIL_TO_GENERATE_3D_STRUCTURE:"Fail to generate 3D structure coordinates"}}),function(){var e=Kekule.EmscriptenUtils,t={usingModulaize:!0,moduleName:"OpenBabelModule",moduleInitEventName:"OpenBabel.Initialized",moduleInitCallbackName:"__$openBabelInitialized$__"};Kekule.OpenBabel={_autoEnabled:!0,_module:null,SCRIPT_FILE:"openbabel.js",_enableFuncs:[],BondOrder:{SINGLE:1,DOUBLE:2,TRIPLE:3,EXPLICIT_AROMATIC:5},getObInitOptions:function(){return t},getModule:function(){return r._module||(r._module=e.getRootModule(t.moduleName)),r._module},setModule:function(l){r._module=l,e.setRootModule(t.moduleName,l)},getClassCtor:function(t){return e.getClassCtor(t,r.getModule())},isScriptLoaded:function(){return e.isSupported(t.moduleName)},isModuleReady:function(){return e.isModuleReady(t.moduleName)},enable:function(e){r.isScriptLoaded()?(r._enableAllFunctions(),e&&e()):r.loadObScript(Kekule.$jsRoot.document,function(t){t||r._enableAllFunctions(),e&&e(t)})},_enableAllFunctions:function(){if(r.isModuleReady())for(var e=r._enableFuncs,t=0,l=e.length;t<l;++t){var n=e[t];n&&n()}}};var r=Kekule.OpenBabel;Kekule._registerAfterLoadSysProc(function(){r._autoEnabled&&r.isScriptLoaded()&&e.ensureModuleReady(Kekule.$jsRoot.document,t,r._enableAllFunctions)}),Kekule.OpenBabel.getObPath=function(){var e=Kekule.environment.getEnvVar("openbabel.path");e||(e=Kekule.isUsingMinJs()?"extra/":"_extras/OpenBabel/",e=Kekule.getScriptPath()+e);return e},Kekule.OpenBabel.getObScriptUrl=function(){var e=Kekule.environment.getEnvVar("openbabel.scriptSrc");e||(e=Kekule.OpenBabel.getObPath()+Kekule.OpenBabel.SCRIPT_FILE,Kekule.isUsingMinJs()||(e+=".dev"));return e},Kekule.OpenBabel.loadObScript=function(l,n){l||(l=Kekule.$jsRoot.document);var o=function(e){r._obScriptLoadedBySelf=!e,n&&n(e)};if(r._obScriptLoadedBySelf||r.isScriptLoaded())o();else{var a=Kekule.OpenBabel.getObScriptUrl();e.loadScript(a,o,l,t)}},Kekule.OpenBabel.AdaptUtils={DEF_ATOM_ID_PREFIX:"A",DEF_BOND_ID_PREFIX:"B",DEF_MOL_ID_PREFIX:"M",wrapCFuncs:function(){if(!Kekule.OpenBabel._funcInited){Object.extend(Kekule.OpenBabel,{}),Kekule.OpenBabel._funcInited=!0}},isAvailable:function(){return void 0!==r.getClassCtor("ObBaseHelper")},obObjToKekule:function(e){var t=Kekule.OpenBabel.AdaptUtils,r=Kekule.ObjUtils.getPrototypeOf(e).constructor.name;return("OBReaction"===r?t.obReactionToKekule:"OBMol"===r?t.obMolToKekule:"OBAtom"===r?t.obAtomToKekule:"OBBond"===r?t.obBondToKekule:t.obBaseToKekule)(e)},kObjToOB:function(e){var t=Kekule.OpenBabel.AdaptUtils,r=e instanceof Kekule.Reaction?t.kReactionToOB:e instanceof Kekule.StructureFragment?t.kMolToOB:e instanceof Kekule.ChemStructureNode?t.kChemNodeToOB:e instanceof Kekule.ChemStructureConnector?t.kBondToOB:null;return r?r(e):null},kIdToOB:function(e){var t=parseInt(e,10);return t||null},obBondOrderToKekule:function(e){return e<=3?e:e===Kekule.OpenBabel.BondOrder.EXPLICIT_AROMATIC?Kekule.BondOrder.EXPLICIT_AROMATIC:Kekule.BondOrder.OTHER},kBondOrderToOB:function(e){return e<=3?e:e===Kekule.BondOrder.EXPLICIT_AROMATIC?Kekule.OpenBabel.BondOrder.EXPLICIT_AROMATIC:0},obBaseToKekule:function(e,t){var l=t||new Kekule.ChemObject,n=new(r.getClassCtor("ObBaseHelper"))(e),o=n.getTitle();o&&l.setName&&l.setName(o);var a=n.getDataSize();if(a)for(var u=l.getInfo(!0),i=0;i<a;++i){var s=n.getDataAt(i);if(s){var O=s.GetAttribute(),d=s.GetValue();O&&d&&(u[O]=d)}}return l},kChemObjToOB:function(e,t){var l=t||new(r.getClassCtor("OBBase"));e.getName&&l.SetTitle&&l.SetTitle(e.getName());var n=e.getInfo();if(n)for(var o=Kekule.ObjUtils.getOwnedFieldNames(n),a=0,u=o.length;a<u;++a){var i=o[a],s=n[i];if(i&&s){var O=new(r.getClassCtor("OBPairData"));O.SetAttribute(""+i),O.SetValue(""+s),l.SetData(O)}}},obAtomToKekule:function(e,t,r){var l=e.GetAtomicNum(),n=l?Kekule.Atom:Kekule.SubGroup;!t||t instanceof n||Kekule.Error(Kekule.$L("ErrorMsg.OpenBabel.CHEM_NODE_TYPE_NOT_SUITABLE"));var o,a=t||new n;return Kekule.OpenBabel.AdaptUtils.obBaseToKekule(e,a),o=e.GetId(),Kekule.ObjUtils.notUnset(o)&&a.setId(Kekule.OpenBabel.AdaptUtils.DEF_ATOM_ID_PREFIX+o),(o=e.GetFormalCharge())&&a.setCharge(o),(o=e.GetSpinMultiplicity())&&a.setRadical(o),o={x:e.GetX(),y:e.GetY()},r===Kekule.CoordMode.COORD3D&&(o.z=e.GetZ()),a.setAbsCoordOfMode?a.setAbsCoordOfMode(o,r):a.setCoordOfMode(o,r),a instanceof Kekule.Atom&&(l&&a.setAtomicNumber(l),(o=e.GetIsotope())&&a.setMassNumber(o),(o=e.GetHyb())&&a.setHybridizationType(o)),a},kChemNodeToOB:function(e,t,l){var n,o=t||new(r.getClassCtor("OBAtom"));if(n=e.getId(),n=Kekule.OpenBabel.AdaptUtils.kIdToOB(n),Kekule.ObjUtils.notUnset(n)&&o.SetId(n),n=e.getCharge())if(parseInt(n,10)===parseFloat(n))o.SetFormalCharge(n);else{var a=parseInt(n,10),u=n-a;o.SetFormalCharge(a),o.SetPartialCharge(u)}return(n=e.getRadical())&&o.SetSpinMultiplicity(n),n=e.getAbsCoordOfMode?e.getAbsCoordOfMode(l):e.getCoordOfMode(l),o.SetVector(n.x||0,n.y||0,n.z||0),e instanceof Kekule.Atom?(o.SetAtomicNum(e.getAtomicNumber()),(n=e.getMassNumber())&&o.SetIsotope(n),(n=e.getHybridizationType())&&o.SetHyb(n)):o.SetAtomicNum(0),o},obBondToKekule:function(e,t,r){var l,n=t||new Kekule.Bond;Kekule.OpenBabel.AdaptUtils.obBaseToKekule(e,n),l=e.GetId(),Kekule.ObjUtils.notUnset(l)&&n.setId(Kekule.OpenBabel.AdaptUtils.DEF_BOND_ID_PREFIX+l),l=e.GetBondOrder(),n.setBondOrder(Kekule.OpenBabel.AdaptUtils.obBondOrderToKekule(l));var o=Kekule.BondStereo;if(l=e.IsWedge()?o.UP:e.IsHash()?o.DOWN:e.IsWedgeOrHash()?o.UP_OR_DOWN:e.IsCisOrTrans()?o.CIS_OR_TRANS:e.IsDoubleBondGeometry()?o.E_Z_BY_COORDINATES:o.NONE,n.setStereo(l),r){l=null;for(var a=[e.GetBeginAtom(),e.GetEndAtom()],u=0,i=a.length;u<i;++u){var s=a[u];s&&(l=r.get(s.GetIdx()))&&n.appendConnectedObj(l)}}return n},kBondToOB:function(e,t,l,n){var o=t||new(r.getClassCtor("OBBond"));Kekule.OpenBabel.AdaptUtils.kChemObjToOB(e,o),O=Kekule.OpenBabel.AdaptUtils.kIdToOB(e.getId()),Kekule.ObjUtils.notUnset(O)&&o.SetId(O),(O=e.getBondOrder())&&(o.SetBondOrder(Kekule.OpenBabel.AdaptUtils.kBondOrderToOB(O)),O===Kekule.BondOrder.EXPLICIT_AROMATIC&&o.SetAromatic()),o.UnsetHash(),o.UnsetWedge(),o.UnsetUp(),o.UnsetDown(),o.UnsetAromatic();var a=Kekule.BondStereo;if((O=e.getStereo())===a.UP?o.SetWedge():O===a.DOWN?o.SetHash():O===a.UP_OR_DOWN&&o.SetWedgeOrHash(),l)for(var u=0,i=0,s=e.getConnectedObjCount();i<s;++i){var O,d=e.getConnectedObjAt(i);if(d&&d instanceof Kekule.ChemStructureNode)if((O=l.get(d))&&(0===u?o.SetBegin(O):1===u&&o.SetEnd(O),++u),u>1)break}return o},obMolToKekule:function(e,t){var r=t||new Kekule.Molecule;Kekule.OpenBabel.AdaptUtils.obBaseToKekule(e,r);var l=e.Has3D()?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D;r.clearNodes(),r.clearConnectors();for(var n=new Kekule.MapEx(!0),o=e.NumAtoms(),a=0;a<o;++a){var u=e.GetAtom(a+1);if(u){var i=Kekule.OpenBabel.AdaptUtils.obAtomToKekule(u,null,l);i&&(r.appendNode(i),n.set(u.GetIdx(),i))}}for(o=e.NumBonds(),a=0;a<o;++a){var s=e.GetBond(a);if(s){var O=Kekule.OpenBabel.AdaptUtils.obBondToKekule(s,null,n);O&&r.appendConnector(O)}}return n.finalize(),n=null,r},kMolToOB:function(e,t){var l=e.nodesHasCoord3D()?Kekule.CoordMode.COORD3D:Kekule.CoordMode.COORD2D,n=t||new(r.getClassCtor("OBMol"));t&&n.Clear();for(var o=new Kekule.MapEx(!1),a=0,u=e.getNodeCount();a<u;++a){var i=e.getNodeAt(a);if(i){var s=Kekule.OpenBabel.AdaptUtils.kChemNodeToOB(i,n.NewAtom(),l);s&&o.set(i,s)}}for(a=0,u=e.getConnectorCount();a<u;++a){var O=e.getConnectorAt(a);if(O&&O instanceof Kekule.Bond)Kekule.OpenBabel.AdaptUtils.kBondToOB(O,n.NewBond(),o,n)}return o.finalize(),o=null,n},obReactionToKekule:function(e,t){var r=t||new Kekule.Reaction;r.clearAll(),Kekule.OpenBabel.AdaptUtils.obBaseToKekule(e,r),r.setDirection(e.IsReversible()?Kekule.ReactionDirection.BIDIRECTION:Kekule.ReactionDirection.FORWARD);for(var l=0,n=e.NumReactants();l<n;++l){var o=e.GetReactant(l),a=Kekule.OpenBabel.AdaptUtils.obMolToKekule(o);r.appendReactant(a)}for(l=0,n=e.NumProducts();l<n;++l){o=e.GetProduct(l),a=Kekule.OpenBabel.AdaptUtils.obMolToKekule(o);r.appendProduct(a)}return r},kReactionToOB:function(e,t){var l=t||new(r.getClassCtor("OBReaction"));l.Clear(),Kekule.OpenBabel.AdaptUtils.kChemObjToOB(e,l);var n=!1,o=e.getDirection();o===Kekule.ReactionDirection.BIDIRECTION?l.SetReversible(!0):o===Kekule.ReactionDirection.BACKWARD&&(n=!0);for(var a=0,u=e.getReactantCount();a<u;++a){if(s=e.getReactantAt(a)){var i=Kekule.OpenBabel.AdaptUtils.kMolToOB(s);n?l.AddProduct(i):l.AddReactant(i)}}for(a=0,u=e.getProductCount();a<u;++a){var s;if(s=e.getProductAt(a)){i=Kekule.OpenBabel.AdaptUtils.kMolToOB(s);n?l.AddReactant(i):l.AddProduct(i)}}}}}(),function(){Kekule.EmscriptenUtils;var e=Kekule.OpenBabel,t=Kekule.OpenBabel.AdaptUtils;Kekule.IO.OpenBabelReader=Class.create(Kekule.IO.ChemDataReader,{CLASS_NAME:"Kekule.IO.OpenBabelReader",initialize:function(e){this.tryApplySuper("initialize")},finalize:function(){this.tryApplySuper("finalize")},getFormatTargetObClassName:function(e){return e.getTypeName().toLowerCase().indexOf("reaction")>=0?"OBReaction":"OBMol"},doReadData:function(r,l,n){this._obConv=new(e.getClassCtor("ObConversionWrapper"));try{var o=Kekule.IO.DataFormatsManager.getFormatInfo(n),a=o.mimeType,u=o.fileExts[0],i=this._obConv.setInFormat(a,u),s=this.getFormatTargetObClassName(i);try{var O=[];this._obConv.setInStr(r);for(var d=new(e.getClassCtor(s)),c=this._obConv.readFromInput(d);c;){if(d.NumAtoms&&d.NumAtoms()>0){var p=t.obObjToKekule(d);O.push(p)}c=this._obConv.readFromInput(d)}var b=O.length;if(b<=0)return null;if(1===b)return O[0];for(var k=new Kekule.ChemObjList,K=0;K<b;++K)k.append(O[K]);return k}finally{d&&(d.delete(),d=null)}}finally{this._obConv&&(this._obConv.delete(),this._obConv=null)}}}),Kekule.IO.OpenBabelWriter=Class.create(Kekule.IO.ChemDataWriter,{CLASS_NAME:"Kekule.IO.OpenBabelWriter",initialize:function(e){this.tryApplySuper("initialize",[e])},finalize:function(){this.tryApplySuper("finalize")},doWriteData:function(r,l,n){this._obConv=new(e.getClassCtor("ObConversionWrapper"));try{var o=Kekule.IO.DataFormatsManager.getFormatInfo(n),a=o.mimeType,u=o.fileExts[0];this._obConv.setOutFormat(a,u);for(var i=Kekule.ChemStructureUtils.getChildStructureObjs(r,!0),s=0,O=i.length;s<O;++s){var d=i[s];if(d){var c=t.kObjToOB(d);if(c)try{if(!this._obConv.writeToOutput(c))break}finally{c.delete(),c=null}}}return this._obConv.getOutStr()}finally{this._obConv&&this._obConv.delete()}},isAllowedObj:function(e){var t=Kekule.IO.OpenBabelWriter.ALLOWED_CLASSES;return Kekule.ObjUtils.isInstanceOf(e,t)}}),Kekule.IO.OpenBabelWriter.ALLOWED_CLASSES=[Kekule.StructureFragment,Kekule.Reaction,Kekule.ChemObjList,Kekule.ChemStructureObjectGroup,Kekule.ChemSpaceElement,Kekule.ChemSpace],Kekule.OpenBabel.IORegHelper=Class.create({listFormatInfo:function(e,t){for(var r=[],l=("in"===e?t.getSupportedInputFormatsStr("\n"):t.getSupportedOutputFormatsStr("\n")).split("\n"),n=0,o=l.length;n<o;++n){var a=l[n],u=a.indexOf("--");if(u>0){var i=a.substring(0,u).trim(),s=t.getFormatInfoById(i);r.push(s)}}return r},registerByInfos:function(e,t){for(var r=Kekule.IO.DataFormatsManager,l=[],n=0,o=e.length;n<o;++n){var a=e[n],u=a.id,i=a.mimeType;if((s=r.findFormatId(i))&&(s=r.findFormatId(null,u)),!s)var s=r.register(u,i,u,Kekule.IO.ChemDataType.UNKNOWN,a.description,a.description,{specificationUrl:a.specificationURL}).id;("in"===t?Kekule.IO.ChemDataReaderManager.getReaderInfoByFormat(s):Kekule.IO.ChemDataWriterManager.getWriterInfoByFormat(s))||Kekule.ArrayUtils.pushUnique(l,s)}l.length&&("in"===t?Kekule.IO.ChemDataReaderManager.register("openbabel",Kekule.IO.OpenBabelReader,l):Kekule.IO.ChemDataWriterManager.register("openbabel",Kekule.IO.OpenBabelWriter,Kekule.IO.OpenBabelWriter.ALLOWED_CLASSES,l))},registerAll:function(){var t=new(e.getClassCtor("ObConversionWrapper"));try{var r=this.listFormatInfo("in",t);this.registerByInfos(r,"in");r=this.listFormatInfo("out",t);this.registerByInfos(r,"out")}finally{t.delete()}}}),Kekule.IO.registerAllOpenBabelFormats=function(){if(Kekule.OpenBabel.AdaptUtils.isAvailable())try{var e=new Kekule.OpenBabel.IORegHelper;e.registerAll()}finally{e=null}},Kekule.OpenBabel._enableFuncs.push(Kekule.IO.registerAllOpenBabelFormats),Kekule.IO.enableOpenBabelFormats=function(){Kekule.OpenBabel.AdaptUtils.isAvailable()?Kekule.IO.registerAllOpenBabelFormats():Kekule.OpenBabel.loadObScript(document,function(){Kekule.IO.registerAllOpenBabelFormats()})}}(),function(){"use strict";Kekule.EmscriptenUtils;var e=Kekule.OpenBabel,t=Kekule.OpenBabel.AdaptUtils;Kekule.OpenBabel.StructUtils={generate3DStructure:function(r,l){var n=new(e.getClassCtor("OB3DGenWrapper"));try{var o=Kekule.IO.saveMimeData(r,"chemical/x-mdl-molfile");try{var a=n.generate3DStructureFromMolData(o,l||"");if(a)var u=t.obObjToKekule(a);else Kekule.raise(Kekule.$L("ErrorMsg.OpenBabel.FAIL_TO_GENERATE_3D_STRUCTURE"));a.delete()}finally{}}finally{n.delete()}return u}},Kekule.Calculator&&(Kekule.Calculator.ObStructure3DGenerator=Class.create(Kekule.Calculator.AbstractStructure3DGenerator,{CLASS_NAME:"Kekule.Calculator.ObStructure3DGenerator",getObInitOptions:function(){return Kekule.OpenBabel.getObInitOptions()},getForceField:function(){return this.getOptions().forceField},createWorker:function(){var e=this.tryApplySuper("createWorker");if(e){var t=Kekule.OpenBabel.getObScriptUrl();this.importWorkerScriptFile(t);var r=this.getObInitOptions();this.postWorkerMessage({type:"obInit",usingModulaize:r.usingModulaize,moduleName:r.moduleName,initCallbackName:r.moduleInitCallbackName})}return e},getWorkerScriptFile:function(){return Kekule.OpenBabel.getObPath()+"kekule.worker.obStructure3DGenerator.js"},doReactWorkerMessage:function(e,t){if(this.tryApplySuper("doReactWorkerMessage",[e,t]),"output3D"===e.type){var r=e.molData;if(r){var l=Kekule.IO.loadMimeData(r,"chemical/x-mdl-molfile");this.setGeneratedMol(l),this.done()}}},workerStartCalc:function(e){var t=this.getSourceMol(),r=Kekule.IO.saveMimeData(t,"chemical/x-mdl-molfile");this.postWorkerMessage({type:"gen3D",molData:r,forceField:this.getForceField()})},executeSync:function(e){if(Kekule.OpenBabel&&document){var t=this;Kekule.OpenBabel.loadObScript(document,function(){var r;try{var l=Kekule.OpenBabel.StructUtils.generate3DStructure(t.getSourceMol(),t.getForceField());t.setGeneratedMol(l)}catch(e){r=e}e&&e(r)})}else Kekule.error(Kekule.$L("ErrorMsg.MODULE_NOT_LOADED").format("OpenBabel"));return!1}}),Kekule.Calculator.ServiceManager.register(Kekule.Calculator.Services.GEN3D,Kekule.Calculator.ObStructure3DGenerator))}();